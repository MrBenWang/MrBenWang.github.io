<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>*旧 WCF 项目成功迁移到 asp.net core web api - 风雪夜归人</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Long" />
  <meta name="description" content="背景 接上一篇，放弃了 asp.net core &#43; gRPC 的方案后，我灵光一闪，为什么不用 web api 呢？不也是 asp.net core 的吗？虽然 RESTful 不是强约束，客户端写起来也麻烦，但还是可以满足基本需求，避免大幅修改旧有的业务逻辑代码。
在网上找到相当多的文章，比较 gRPC 和 RESTful 的优缺点，结论都是 gRPC 推荐用作内部系统间调用， RESTful 推荐用作对外开放接口。
选择 RESTful 另一个最重要的原因是，gRPC 的底层框架需要HTTP2，而 win7 不支持HTTP2，有相当一部分用户在 win7 上。上篇有人推荐 grpc web ，由于项目是 WPF 桌面客户端，这种 web 方式可能就更不适合了。
" />

  <meta name="keywords" content="码农, 逻辑, 自由" />



<meta name="google-site-verification" content="hqw-Lg4woniVGx2b2LZ25xQDQsh_da1VWm_nhza2aZg" />


<meta name="generator" content="Hugo 0.74.3" />


<link rel="canonical" href="https://mrbenwang.github.io/post/2020/20200814-wcf-to-aspnetcore-webapi/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="*旧 WCF 项目成功迁移到 asp.net core web api" />
<meta property="og:description" content="背景
接上一篇，放弃了 asp.net core &#43; gRPC 的方案后，我灵光一闪，为什么不用 web api 呢？不也是 asp.net core 的吗？虽然 RESTful 不是强约束，客户端写起来也麻烦，但还是可以满足基本需求，避免大幅修改旧有的业务逻辑代码。
在网上找到相当多的文章，比较 gRPC 和 RESTful 的优缺点，结论都是 gRPC 推荐用作内部系统间调用， RESTful 推荐用作对外开放接口。
选择 RESTful 另一个最重要的原因是，gRPC 的底层框架需要HTTP2，而 win7 不支持HTTP2，有相当一部分用户在 win7 上。上篇有人推荐 grpc web ，由于项目是 WPF 桌面客户端，这种 web 方式可能就更不适合了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mrbenwang.github.io/post/2020/20200814-wcf-to-aspnetcore-webapi/" />
<meta property="article:published_time" content="2020-08-14T11:11:00+08:00" />
<meta property="article:modified_time" content="2020-08-14T23:46:00+08:00" />
<meta itemprop="name" content="*旧 WCF 项目成功迁移到 asp.net core web api">
<meta itemprop="description" content="背景
接上一篇，放弃了 asp.net core &#43; gRPC 的方案后，我灵光一闪，为什么不用 web api 呢？不也是 asp.net core 的吗？虽然 RESTful 不是强约束，客户端写起来也麻烦，但还是可以满足基本需求，避免大幅修改旧有的业务逻辑代码。
在网上找到相当多的文章，比较 gRPC 和 RESTful 的优缺点，结论都是 gRPC 推荐用作内部系统间调用， RESTful 推荐用作对外开放接口。
选择 RESTful 另一个最重要的原因是，gRPC 的底层框架需要HTTP2，而 win7 不支持HTTP2，有相当一部分用户在 win7 上。上篇有人推荐 grpc web ，由于项目是 WPF 桌面客户端，这种 web 方式可能就更不适合了。">
<meta itemprop="datePublished" content="2020-08-14T11:11:00+08:00" />
<meta itemprop="dateModified" content="2020-08-14T23:46:00+08:00" />
<meta itemprop="wordCount" content="5488">



<meta itemprop="keywords" content="net core,web api," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="*旧 WCF 项目成功迁移到 asp.net core web api"/>
<meta name="twitter:description" content="背景
接上一篇，放弃了 asp.net core &#43; gRPC 的方案后，我灵光一闪，为什么不用 web api 呢？不也是 asp.net core 的吗？虽然 RESTful 不是强约束，客户端写起来也麻烦，但还是可以满足基本需求，避免大幅修改旧有的业务逻辑代码。
在网上找到相当多的文章，比较 gRPC 和 RESTful 的优缺点，结论都是 gRPC 推荐用作内部系统间调用， RESTful 推荐用作对外开放接口。
选择 RESTful 另一个最重要的原因是，gRPC 的底层框架需要HTTP2，而 win7 不支持HTTP2，有相当一部分用户在 win7 上。上篇有人推荐 grpc web ，由于项目是 WPF 桌面客户端，这种 web 方式可能就更不适合了。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-130619472-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">风雪夜归人</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/about/">关于</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '015982908853339398897:duxagwzp5jn';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      风雪夜归人
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/about/">关于</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">*旧 WCF 项目成功迁移到 asp.net core web api</h1>
      
      <div class="post-meta">
        <time datetime="2020-08-14" class="post-time">
          2020-08-14 11:11
        </time>
        <div class="post-category">
            <a href="https://mrbenwang.github.io/categories/%E5%B7%A5%E4%BD%9C%E9%9A%8F%E7%AC%94/"> 工作随笔 </a>
            
          </div>
        <span class="more-meta"> 约 5488 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#entity-framework-core">Entity Framework Core</a>
      <ul>
        <li><a href="#基础安装和配置">基础安装和配置</a></li>
        <li><a href="#ef6-to-ef-core-31">EF6 to EF Core 3.1</a></li>
        <li><a href="#其他问题">其他问题</a></li>
      </ul>
    </li>
    <li><a href="#服务端-aspnet-core-web-api">服务端 asp.net core web api</a>
      <ul>
        <li><a href="#启动类-startup">启动类 StartUp</a></li>
        <li><a href="#路由-和-controller">路由 和 Controller</a></li>
        <li><a href="#nswag">Nswag</a></li>
        <li><a href="#上传文件">上传文件</a></li>
        <li><a href="#全局异常捕获">全局异常捕获</a></li>
      </ul>
    </li>
    <li><a href="#客户端-webapiclient">客户端 WebApiClient</a>
      <ul>
        <li><a href="#webapiclienttool">WebApiClient.Tool</a></li>
        <li><a href="#webapiclientjit">WebApiClient.JIT</a></li>
      </ul>
    </li>
    <li><a href="#部署-ubuntu--nginx">部署 Ubuntu + Nginx</a>
      <ul>
        <li><a href="#自动化脚本">自动化脚本</a></li>
      </ul>
    </li>
    <li><a href="#其他的改动">其他的改动</a>
      <ul>
        <li><a href="#log4net">log4net</a></li>
        <li><a href="#framework-40-的-md5-方法废弃">Framework 4.0 的 md5 方法废弃</a></li>
        <li><a href="#datetimeoffset-和-datetime">DateTimeOffset 和 DateTime</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="背景">背景</h2>
<p>接上一篇，放弃了 asp.net core + gRPC 的方案后，我灵光一闪，为什么不用 web api 呢？不也是 asp.net core 的吗？虽然 RESTful 不是强约束，客户端写起来也麻烦，但还是可以满足基本需求，<strong>避免大幅修改</strong><code>旧有的业务逻辑代码</code>。</p>
<p>在网上找到相当多的文章，比较 gRPC 和 RESTful 的优缺点，结论都是 <code>gRPC</code> 推荐用作<strong>内部系统间调用</strong>， <code>RESTful</code> 推荐用作<strong>对外开放接口</strong>。<br>
选择 <code>RESTful</code> 另一个最重要的原因是，<code>gRPC</code> 的底层框架需要HTTP2，而 win7 不支持HTTP2，有相当一部分用户在 win7 上。上篇有人推荐 <code>grpc web</code> ，由于项目是 <strong>WPF 桌面客户端</strong>，这种 web 方式可能就更不适合了。</p>
<h2 id="entity-framework-core">Entity Framework Core</h2>
<h3 id="基础安装和配置">基础安装和配置</h3>
<blockquote>
<p>这部分基本与上一篇的前半部分内容一致，为了保证单篇文章的独立性。把这部分内容完全 copy 过来🙄🙄🙄。</p>
</blockquote>
<p>旧的WCF项目，数据库访问使用的是 Entity Framework + Linq + MySql。需要安装的 Nuget 包：</p>
<ul>
<li><code>MySql.Data.EntityFrameworkCore</code> Mysql的EF核心库；</li>
<li><code>Microsoft.EntityFrameworkCore.Proxies</code> <a href="https://docs.microsoft.com/en-us/ef/core/querying/related-data#lazy-loading">《Lazy loading 》</a> 懒加载的插件；</li>
<li><code>Microsoft.EntityFrameworkCore.Design</code> 和 <code>Microsoft.EntityFrameworkCore.Tools</code> 这两个插件，用于生成代码；</li>
</ul>
<p>另外，还需要下载安装 <a href="https://dev.mysql.com/downloads/connector/net/">mysql-connector-net-8.0.21.msi</a> 来访问数据库。其中有一个 <code>Scaffold-DbContext</code> 的<a href="https://bugs.mysql.com/bug.php?id=99419">bug 99419</a> TINYINT(1) 转化为 byte，而不是预期的 bool。这个问题将会在 8.0.22 版本中修复，目前只能手动修改。<br>
EF当然是 <code>Database First</code> 了，生成EF代码需要在<code>Package Manager Console</code>用到 <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/powershell#scaffold-dbcontext">Scaffold-DbContext</a> 命令，有三点需要注意：</p>
<ul>
<li><code>Start up</code> 启始项目一定要是引用它的项目，并且编译成功的；</li>
<li><code>Default project</code> 生成后，代码存放的项目；</li>
<li>如果生成失败，提示：“Your startup project &lsquo;XXXX&rsquo; doesn&rsquo;t reference Microsoft.EntityFrameworkCore.Design. This package is required for the Entity Framework Core Tools to work. Ensure your startup project is correct, install the package, and try again.”。编辑项目文件 csproj 移除 <code>&lt;PrivateAssets&gt;All&lt;/PrivateAssets&gt;</code> 从 &ldquo;Microsoft.EntityFrameworkCore.Design&quot;和&quot;Microsoft.EntityFrameworkCore.Tools&quot;中；</li>
</ul>
<p><img src="/images/2020/20200814-wcf-to-aspnetcore-webapi/01-ef-general-code-edit-csproj.jpg" alt="EF remove PrivateAssets"></p>
<p>我的命令： <code>Scaffold-DbContext -Connection &quot;server=10.50.40.50;port=3306;user=myuser;password=123456;database=dbname&quot; -Provider MySql.Data.EntityFrameworkCore -OutputDir &quot;EFModel&quot; -ContextDir &quot;Context&quot; -Project &quot;DataAccess&quot; -Context &quot;BaseEntities&quot; -UseDatabaseNames -Force</code></p>
<p>其他建议：</p>
<ul>
<li>Library类库最好是 <code>Net Standard</code> 方便移植；</li>
<li>新建一个类来继承<code>BaseEntities</code>，覆盖 <code>OnConfiguring</code> 方法，可配置的数据库连接字符串；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Entities</span> <span class="p">:</span> <span class="n">BaseEntities</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">_lstDBString</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">SetDefaultDBString</span><span class="p">(</span><span class="kt">string</span> <span class="n">_dbString</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">_lstDBString</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">_lstDBString</span> <span class="p">=</span> <span class="n">_dbString</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="n">OnConfiguring</span><span class="p">(</span><span class="n">DbContextOptionsBuilder</span> <span class="n">optionsBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">optionsBuilder</span><span class="p">.</span><span class="n">IsConfigured</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">optionsBuilder</span><span class="p">.</span><span class="n">UseLazyLoadingProxies</span><span class="p">().</span><span class="n">UseMySQL</span><span class="p">(</span><span class="n">_lstDBString</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>最好采用 asp.net core 的框架注入；鉴于项目的原因，假如强行采用的话，改动比较大，只好放弃；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">void</span> <span class="n">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">_dbString</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">.</span><span class="n">GetConnectionString</span><span class="p">(</span><span class="s">&#34;MyDatabase&#34;</span><span class="p">);</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">DataAccess</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Entities</span><span class="p">&gt;(</span>
        <span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="n">UseLazyLoadingProxies</span><span class="p">().</span><span class="n">UseMySQL</span><span class="p">(</span><span class="n">_dbString</span><span class="p">));</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddGrpc</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>数据库链接字符串有多种存放的方式，有更加安全的方式<a href="https://docs.microsoft.com/zh-cn/aspnet/core/security/app-secrets?view=aspnetcore-3.1&amp;tabs=windows#environment-variables">《ASP.NET Core 中的开发中安全存储应用机密》</a>；而我采用简单方式，存放在 <code>appsettings.json</code>；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;ConnectionStrings&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;MyDatabase&#34;</span><span class="p">:</span> <span class="s2">&#34;server=127.0.0.1;port=3306;user=myuser;password=123456;database=dbname&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;log4net&#34;</span><span class="p">:</span> <span class="s2">&#34;log4net.config&#34;</span><span class="p">,</span>
    <span class="nt">&#34;Logging&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;LogLevel&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;Default&#34;</span><span class="p">:</span> <span class="s2">&#34;Information&#34;</span><span class="p">,</span>
            <span class="nt">&#34;Microsoft&#34;</span><span class="p">:</span> <span class="s2">&#34;Warning&#34;</span><span class="p">,</span>
            <span class="nt">&#34;Microsoft.Hosting.Lifetime&#34;</span><span class="p">:</span> <span class="s2">&#34;Information&#34;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&#34;AllowedHosts&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="ef6-to-ef-core-31">EF6 to EF Core 3.1</h3>
<p>从 Entity Framework 6 迁移到 Entity Framework Core 3.1 的调整：</p>
<ol>
<li>
<p>提示错误：<code>“Set operations over different store types are currently unsupported”</code>。Union 的使用改变，需要添加 <code>AsEnumerable()</code>，在 EF5.0 会修复这个问题 <a href="https://github.com/dotnet/efcore/issues/18091#issuecomment-536069419">issues</a>；<code>AsEnumerable()</code> 操作的是 将 <strong>Linq to Sql</strong> 切换为 <strong>Linq to Objects</strong> 可以支持 L2O 的所有操作；</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="p">(</span><span class="k">from</span> <span class="n">a</span> <span class="k">in</span> <span class="n">context</span><span class="p">.</span><span class="n">km_folder</span>
            <span class="k">select</span> <span class="k">new</span> <span class="n">FolderFileModel</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">Id</span> <span class="p">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">Name</span> <span class="p">=</span> <span class="n">a</span><span class="p">.</span><span class="n">folder_name</span>
            <span class="p">}).</span><span class="n">AsEnumerable</span><span class="p">().</span>
            <span class="n">Union</span><span class="p">(</span><span class="k">from</span> <span class="n">a</span> <span class="k">in</span> <span class="n">context</span><span class="p">.</span><span class="n">km_fileinfo</span>
                <span class="k">select</span> <span class="k">new</span> <span class="n">FolderFileModel</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">Id</span> <span class="p">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">Name</span> <span class="p">=</span> <span class="n">a</span><span class="p">.</span><span class="n">file_name</span>
                <span class="p">}).</span><span class="n">AsEnumerable</span><span class="p">();</span>

<span class="c1">// Linq to Sql 切换为 Linq to Objects ， 可以执行 外部方法
</span><span class="c1"></span><span class="kt">var</span> <span class="n">query2</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Observations</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span><span class="p">).</span><span class="n">AsEnumerable</span><span class="p">().</span><span class="n">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">MySuperSmartMethod</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>直接执行 sql 语句的方式发生改变， sql查询结果 与 model 里面的字段要一一对应，如果不需要的字段可以添加 <code>[NotMapped]</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// EF 6
</span><span class="c1"></span><span class="n">context</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">SqlQuery</span><span class="p">&lt;</span><span class="n">FolderFileModel</span><span class="p">&gt;(</span><span class="n">sql</span><span class="p">,</span> <span class="n">techArgs</span><span class="p">);</span>

<span class="c1">// EF core
</span><span class="c1"></span>
<span class="c1">/// &lt;summary&gt;
</span><span class="c1">/// 为了兼容执行sql的方法，参考写法
</span><span class="c1">/// https://stackoverflow.com/a/50452479/6667125
</span><span class="c1">/// &lt;/summary&gt;
</span><span class="c1"></span><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">BaseEntities</span> <span class="p">:</span> <span class="n">DbContext</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">FolderFileModel</span><span class="p">&gt;</span> <span class="n">FolderFileModels</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">partial</span> <span class="k">void</span> <span class="n">OnModelCreatingPartial</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">FolderFileModel</span><span class="p">&gt;().</span><span class="n">HasNoKey</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">FolderFileModel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">long?</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">    [NotMapped]</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsSelected</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 执行方法
</span><span class="c1"></span><span class="n">context</span><span class="p">.</span><span class="n">FolderFileModels</span><span class="p">.</span><span class="n">FromSqlRaw</span><span class="p">(</span><span class="s">&#34;SQL SCRIPT&#34;</span><span class="p">,</span> <span class="n">techArgs</span><span class="p">).</span><span class="n">ToList</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="其他问题">其他问题</h3>
<p>出现问题：<code>指定的架构无效。错误: CLR 类型到 EDM 类型的映射不明确，因为多个 CLR 类型与 EDM 类型“user”匹配。</code></p>
<p>DbContext 的 MetadataWorkSpace 一旦生成会缓存起来。也就是说，在同一个应用程序域里面，一旦用dbcontext操作过数据库，它会自动读取类所在 assembly 里面的所有类，并尝试匹配数据库模型，然后将匹配结果保存起来(保存到上面的MetaOCSpace中)。当下次操作数据库时，返回数据对应类类所在其它assembly里面的类与当前已匹配数据库模型发生冲突时，便会报错。（这段话是网上抄的）</p>
<div class="shortcode-notice note">
  <div class="shortcode-notice-title note">
    
    在ASP.NET MVC5高级编程（第5版）中第70页作者写到
    
  </div>
  <p>
实体框架的另一种（默认的）策略是延迟加载策略。使用延迟建在策略，EF在LINQ查询中只加载主要对象（专辑）的数据，而不填充Genre和Artist属性。  
var albums=db.Albums;  
延迟加载根据需要来加载相关数据，也就是说，只有当Album的Genre或Artist需要属性时，EF才会公国向数据库发送一个个额外的查询来加载这些数据。延迟加载策略会强制框架未列表中每一个专辑向数据库发送一个额外的查询。  
</p>
</div>
<p>我的理解是，懒加载通过反射来查找实体对象，而该程序集中，存在多个同名的类型，即使改类型在<strong>不同命名空间</strong>下也会报错。只要将相同的类型名称，改为不一样即可。</p>
<h2 id="服务端-aspnet-core-web-api">服务端 asp.net core web api</h2>
<p>这部分可是水还是有点深了。由于最近几年主要以 WPF 桌面软件开发为主，很少了解 asp.net core 。这次算是恶补了一下，下面是个人总结，<strong>一切以官方文档为准</strong>。</p>
<h3 id="启动类-startup">启动类 StartUp</h3>
<p>启动类 <code>StartUp.cs</code> ，在这里面主要是<strong>注册服务</strong>(Swagger、mvc等)，<strong>注册中间件</strong>(身份认证、全局异常捕获等)，以及<strong>不同环境的切换</strong>(Development、Production)。下面是我的 StartUp 类，有几点经验总结：</p>
<ul>
<li>初始化读取全局配置参数，比如 <code>log4net.config</code>，<code>连接字符串</code>等；</li>
<li>web api 只需要添加 <code>services.AddControllers();</code>，而不是 AddMvc();</li>
<li>Swagger <strong>只在开发环境下启用</strong>，而<strong>生产环境无效</strong>，<a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/environments?view=aspnetcore-3.1#startup-class-conventions">《在 ASP.NET Core 中使用多个环境》</a> 多环境开发测试，真的太好用了，<strong>强烈推荐使用</strong>；</li>
<li>在根路径下增加返回内容<code>Hello Asp.Net Core WebApi 3.1!</code>，为了方便测试是否运行成功。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">void</span> <span class="n">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">InitConfig</span><span class="p">();</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddControllers</span><span class="p">();</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddSwaggerDocument</span><span class="p">(</span><span class="n">SwaggerDocumentConfig</span><span class="p">);</span> <span class="c1">// Register the Swagger services
</span><span class="c1"></span><span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="n">InitConfig</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Entities</span><span class="p">.</span><span class="n">SetDefaultDBString</span><span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">GetConnectionString</span><span class="p">(</span><span class="s">&#34;MyDatabase&#34;</span><span class="p">));</span>
    <span class="n">Common</span><span class="p">.</span><span class="n">LogMaker</span><span class="p">.</span><span class="n">InitLog4NetConfig</span><span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">GetSection</span><span class="p">(</span><span class="s">&#34;log4net&#34;</span><span class="p">).</span><span class="n">Value</span><span class="p">);</span>
    <span class="n">Common</span><span class="p">.</span><span class="n">WebApiLogger</span><span class="p">.</span><span class="n">Singleton</span><span class="p">.</span><span class="n">LogMaker</span><span class="p">.</span><span class="n">LogInfo</span><span class="p">(</span><span class="s">&#34;Start WebApi!&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="n">SwaggerDocumentConfig</span><span class="p">(</span><span class="n">NSwag</span><span class="p">.</span><span class="n">Generation</span><span class="p">.</span><span class="n">AspNetCore</span><span class="p">.</span><span class="n">AspNetCoreOpenApiDocumentGeneratorSettings</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">config</span><span class="p">.</span><span class="n">PostProcess</span> <span class="p">=</span> <span class="n">document</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">document</span><span class="p">.</span><span class="n">Info</span><span class="p">.</span><span class="n">Version</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Startup</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetName</span><span class="p">().</span><span class="n">Version</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
        <span class="n">document</span><span class="p">.</span><span class="n">Info</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&#34;Test Web Api&#34;</span><span class="p">;</span>
        <span class="n">document</span><span class="p">.</span><span class="n">Info</span><span class="p">.</span><span class="n">Description</span> <span class="p">=</span> <span class="s">&#34;仅供测试和发开使用。&#34;</span><span class="p">;</span>
        <span class="n">document</span><span class="p">.</span><span class="n">Info</span><span class="p">.</span><span class="n">Contact</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSwag</span><span class="p">.</span><span class="n">OpenApiContact</span>
        <span class="p">{</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;long&#34;</span><span class="p">,</span>
            <span class="n">Email</span> <span class="p">=</span> <span class="s">&#34;long@test.com&#34;</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span>


<span class="k">public</span> <span class="k">void</span> <span class="n">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IWebHostEnvironment</span> <span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">IsDevelopment</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">app</span><span class="p">.</span><span class="n">UseDeveloperExceptionPage</span><span class="p">();</span>

        <span class="c1">// Register the Swagger generator and the Swagger UI middlewares
</span><span class="c1"></span>        <span class="n">app</span><span class="p">.</span><span class="n">UseOpenApi</span><span class="p">();</span>
        <span class="n">app</span><span class="p">.</span><span class="n">UseSwaggerUi3</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">app</span><span class="p">.</span><span class="n">UseCustomExceptionMiddleware</span><span class="p">();</span> <span class="c1">// 全局异常中间件
</span><span class="c1"></span>    <span class="n">app</span><span class="p">.</span><span class="n">UseRouting</span><span class="p">();</span>
    <span class="n">app</span><span class="p">.</span><span class="n">UseAuthorization</span><span class="p">();</span>
    <span class="n">app</span><span class="p">.</span><span class="n">UseEndpoints</span><span class="p">(</span><span class="n">endpoints</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">endpoints</span><span class="p">.</span><span class="n">MapGet</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&#34;Hello Asp.Net Core WebApi 3.1!&#34;</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="n">endpoints</span><span class="p">.</span><span class="n">MapControllers</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="路由-和-controller">路由 和 Controller</h3>
<p>真心的觉得 asp.net core 的路由设计，真的是太棒了！而我只用到了其中<strong>很小的一部分</strong><a href="https://docs.microsoft.com/zh-cn/aspnet/core/mvc/controllers/routing?view=aspnetcore-3.1#attribute-routing-for-rest-apis">《REST Api 的属性路由》</a>。其中有个注意点，<strong>全局路由与属性路由会有冲突</strong>，需要特别注意。</p>
<p>为了方便管理路由，灵活使用，以及后期版本的维护，创建一个<code>路由模板</code>和 <code>Controller基类</code>，所有 Controller 都继承自 <code>MyControllerBase</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyV1ApiRouteAttribute</span> <span class="p">:</span> <span class="n">Attribute</span><span class="p">,</span> <span class="n">IRouteTemplateProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Template</span> <span class="p">=&gt;</span> <span class="s">&#34;api/v1/[controller]/[action]&#34;</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int?</span> <span class="n">Order</span> <span class="p">=&gt;</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="na">
</span><span class="na">[ApiController]</span>
<span class="na">[MyV1ApiRoute]</span>
<span class="na">[Produces(MediaTypeNames.Application.Json)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">MyControllerBase</span> <span class="p">:</span> <span class="n">ControllerBase</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="nswag">Nswag</h3>
<p><code>Nswag</code> 和 <code>Swashbuckle</code> 是微软官方推荐的 Swagger 工具(<a href="https://petstore.swagger.io/">官方 swagger 在线试用</a>😆)。我选择 Nswag 的主要原因是，它提供的工具，<strong>根据 API 生成 C# 客户端代码</strong>，其实到最后我也没有使用这个功能。 <a href="https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/getting-started-with-nswag?view=aspnetcore-3.1&amp;tabs=visual-studio">《NSwag 和 ASP.NET Core 入门》</a>。</p>
<p>Nswag 使用起来也非常简单，参考我的 <a href="#%E5%90%AF%E5%8A%A8%E7%B1%BB-startup">启动类 StartUp</a> 中的写法。如果想要把代码中的注释也体现在 Swagger 文档中，需要执行一些额外的操作。<br>
在 csproj 文件中增加 <code>&lt;GenerateDocumentationFile&gt;true&lt;/GenerateDocumentationFile&gt;</code>，另外，最好在 <code>/Project/PropertyGroup/NoWarn</code> 中增加 1591，否则你会得到一大堆的 warning : <strong># CS1591: Missing XML comment for publicly visible type or member</strong>. 原因是项目中<strong>存在没有注释的方法，属性或类</strong>。</p>
<p><img src="/images/2020/20200814-wcf-to-aspnetcore-webapi/02-vs-swagger.jpg" alt="vs-swagger"></p>
<p>注：用 swaggerUI 来测试的话，可能会出现两个问题：</p>
<ol>
<li>如果用 nginx 转发的话，会需要 跨域 CORS 的支持；</li>
<li>实际使用本地网络发送过去的，比如，在 10.40.50.237 上面搭建的 webapi，而 swaggerUI 发送地址 <code>http://localhost:5000/api/xxx</code>。</li>
</ol>
<h3 id="上传文件">上传文件</h3>
<p>这里的方法只适合小文件，如果需要大文件上传，需要用到 steam ，多文件上传参数改为 <code>List&lt;IFormFile&gt;</code> 即可。 <code>DisableRequestSizeLimit</code> 取消上传限制。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="na">[HttpPost, DisableRequestSizeLimit]</span>
<span class="k">public</span> <span class="kt">bool</span> <span class="n">SendStream</span><span class="p">(</span><span class="n">IFormFile</span> <span class="n">_file</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">_newFileName</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">UploadFileManagementBLL</span><span class="p">.</span><span class="n">Singleton</span><span class="p">.</span><span class="n">StoragePath</span><span class="p">,</span> <span class="n">_file</span><span class="p">.</span><span class="n">FileName</span><span class="p">);</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">FileStream</span> <span class="n">fs</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">_newFileName</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">_file</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
        <span class="n">fs</span><span class="p">.</span><span class="n">Flush</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="全局异常捕获">全局异常捕获</h3>
<p>用到自定义中间件，而 asp.net core 提供的 <code>UseExceptionHandler</code> <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/error-handling?view=aspnetcore-3.1#exception-handler-page">《Handle errors in ASP.NET Core》</a> 我觉得不太好用。<br>
日志唯一ID： <code>TraceIdentifier</code>，方便日后跟踪日志； <code>UseCustomExceptionMiddleware</code> 在 startup.cs 中一定要放在第一位，中间件的顺序是有非常重要的影响的 <a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/middleware/?view=aspnetcore-3.1#middleware-order">《中间件顺序》</a>。</p>
<p><img src="/images/2020/20200814-wcf-to-aspnetcore-webapi/03-middleware-pipeline.svg" alt="官方的图片"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomExceptionMiddleware</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">RequestDelegate</span> <span class="n">_next</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">CustomExceptionMiddleware</span><span class="p">(</span><span class="n">RequestDelegate</span> <span class="n">next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_next</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">Invoke</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">_next</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">HandleExceptionAsync</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Task</span> <span class="n">HandleExceptionAsync</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Common</span><span class="p">.</span><span class="n">WebApiLogger</span><span class="p">.</span><span class="n">Singleton</span><span class="p">.</span><span class="n">LogMaker</span><span class="p">.</span><span class="n">LogInfo</span><span class="p">(</span><span class="s">$&#34;Unhandled exception UID:[{context.TraceIdentifier}] Message:[{ex}]&#34;</span><span class="p">);</span>

        <span class="kt">string</span> <span class="n">_retString</span> <span class="p">=</span> <span class="s">$&#34;Error! Please contact the administrator.ErrorId:[{context.TraceIdentifier}] Exception:[{ex.Message}].&#34;</span><span class="p">;</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">InternalServerError</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="n">_retString</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CustomExceptionMiddlewareExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IApplicationBuilder</span> <span class="n">UseCustomExceptionMiddleware</span><span class="p">(</span><span class="k">this</span> <span class="n">IApplicationBuilder</span> <span class="n">builder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="n">UseMiddleware</span><span class="p">&lt;</span><span class="n">CustomExceptionMiddleware</span><span class="p">&gt;();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="客户端-webapiclient">客户端 WebApiClient</h2>
<p>在网上寻找有没有现成的 RESTful 的 C# 工具，发现了<a href="https://github.com/dotnetcore/WebApiClient">WebApiClient</a>，看了一下样例，确实非常简单，非常省事儿，只需要写个简单的 Interface 接口类，就可以了，关键是它还<strong>支持各种奇奇怪怪的 HTTP 接口</strong>。<br>
PS: 最开始读 README.md 时候，总是一脸懵逼，一直把它当成 server 端的工具😓。直到开始写客户端的时候，才真正看懂了他的文档。</p>
<h3 id="webapiclienttool">WebApiClient.Tool</h3>
<p><strong>Swagger 是一个与语言无关的规范，用于描述 REST API</strong>。既然 Swagger 是一种规范，那么极有可能存在，根据 <code>Swagger.json</code> 生成代码的工具。想着 WebApiClient 开发者是不是也已经提供了工具，果然不出所料，<a href="https://github.com/xljiulang/WebApiClient.Tools">WebApiClient.Tools</a></p>
<p>只需运行一行命令，就可以根据 <code>Swagger.json</code> 直接生成客户端的实体类，接口，甚至包括注释，简直爽的不要不要的，<strong>完美的避开了手写代码的过程</strong>。<br>
我的命令： <code>WebApiClient.Tools.Swagger.exe --swagger=http://10.50.40.237:5000/swagger/v1/swagger.json --namespace=MyWebApiProxy</code></p>
<h3 id="webapiclientjit">WebApiClient.JIT</h3>
<p>由于还有一大部分的 win7 桌面软件用户，而他们大概率不会安装 net core ，所以只能选择 net framework 的版本 <a href="https://github.com/dotnetcore/WebApiClient/tree/WebApiClient.JITAOT">WebApiClient.JIT</a>。使用起来也相当方便，只需要在启动的时候初始化一下webapi地址，然后在需要的时候调用即可。<br>
WebApiClient 提供的是一个异步的接口，由于旧项目升级，避免大幅改动，就没有使用异步的功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">InitialWebApiConfig</span><span class="p">(</span><span class="kt">string</span> <span class="n">_baseUrl</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HttpApi</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IUserManagementApi</span><span class="p">&gt;().</span><span class="n">ConfigureHttpApiConfig</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="n">HttpHost</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="n">_baseUrl</span><span class="p">);</span>
        <span class="n">c</span><span class="p">.</span><span class="n">FormatOptions</span><span class="p">.</span><span class="n">DateTimeFormat</span> <span class="p">=</span> <span class="n">DateTimeFormats</span><span class="p">.</span><span class="n">ISO8601_WithoutMillisecond</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="n">Todo</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">HttpApi</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IUserManagementApi</span><span class="p">&gt;())</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">_req</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LoginRequestV2</span><span class="p">();</span>
        <span class="n">_response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">UserLoginExAsync</span><span class="p">(</span><span class="n">_req</span><span class="p">).</span><span class="n">InvokeAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="部署-ubuntu--nginx">部署 Ubuntu + Nginx</h2>
<p>项目的服务端，对操作系统没有特别要求，所以直接选择最新的 <code>Ubuntu 20.04.1 LTS</code> 。吸取了 gRPC 部署的一些经验，这次只部署 http 服务，额外增加了 nginx 反向代理，只是因为在官网上看到了<a href="https://docs.microsoft.com/zh-cn/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-3.1">《使用 Nginx 在 Linux 上托管 ASP.NET Core》</a>😜。</p>
<p>Kestrel 是 ASP.NET Core 项目模板指定的默认 Web 服务器，所以一般情况下，ASP.NET Core是不需要额外的容器的。<a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/?view=aspnetcore-3.1&amp;tabs=windows#kestrel">《ASP.NET Core 中的 Web 服务器实现》</a>。下面是我的具体实现操作：</p>
<ol>
<li>
<p>根据文档<a href="https://docs.microsoft.com/zh-cn/dotnet/core/install/linux-ubuntu#2004-">《在 Linux 上安装 .NET Core》</a> 和 <a href="https://docs.microsoft.com/zh-cn/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-3.1#install-nginx">《安装 Nginx》</a> 指引，安装 <code>aspnetcore-runtime-3.1</code> 和 <code>nginx</code>；</p>
</li>
<li>
<p>配置 Nginx ，这部分我用的比较简单，只用到转发功能，未来可能在这一层<strong>增加 SSL</strong> ；另外 <code>try_files $uri $uri/ =404</code> 这一句需要注释掉才行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">&gt; sudo nano /etc/nginx/sites-available/default

server <span class="o">{</span>
    listen <span class="m">80</span> default_server<span class="p">;</span>
    listen <span class="o">[</span>::<span class="o">]</span>:80 default_server<span class="p">;</span>

    root /var/www/html<span class="p">;</span>
    index index.html index.htm index.nginx-debian.html<span class="p">;</span>
    server_name _<span class="p">;</span>
    location / <span class="o">{</span>
            <span class="c1"># First attempt to serve request as file, then</span>
            <span class="c1"># as directory, then fall back to displaying a 404.</span>
            <span class="c1"># try_files $uri $uri/ =404;</span>
            proxy_pass http://localhost:5000<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>

&gt; sudo nginx -t    <span class="c1"># 验证配置文件的语法</span>
&gt; sudo nginx -s reload
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建 Linux 的 web api 的服务文件，并启动。我的示例，<code>--urls</code>这个是非常实用的参数，可多端口；<strong>重点注意</strong> <code>ASPNETCORE_ENVIRONMENT</code> 在配置<strong>是生产环境，还是开发环境</strong>；</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">&gt; sudo nano /etc/systemd/system/kestrel-mywebapi.service

<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>mywebapi App running on Ubuntu

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">WorkingDirectory</span><span class="o">=</span>/home/user/publish
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/dotnet /home/user/publish/MyWebApi.dll --urls http://localhost:5000
<span class="nv">Restart</span><span class="o">=</span>always
<span class="c1"># Restart service after 10 seconds if the dotnet service crashes:</span>
<span class="nv">RestartSec</span><span class="o">=</span><span class="m">10</span>
<span class="nv">KillSignal</span><span class="o">=</span>SIGINT
<span class="nv">SyslogIdentifier</span><span class="o">=</span>dotnet-example
<span class="nv">User</span><span class="o">=</span>user
<span class="c1"># Production Development</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">ASPNETCORE_ENVIRONMENT</span><span class="o">=</span>Development
<span class="nv">Environment</span><span class="o">=</span><span class="nv">DOTNET_PRINT_TELEMETRY_MESSAGE</span><span class="o">=</span><span class="nb">false</span>

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target

&gt; sudo systemctl <span class="nb">enable</span> kestrel-mywebapi.service
&gt; sudo systemctl restart kestrel-mywebapi.service
&gt; sudo systemctl status kestrel-mywebapi.service
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>开启防火墙端口，Ubuntu 是<strong>默认关闭22端口</strong>。安全起见，避免被频繁扫描，建议把 ssh 默认端口 22 改为其他不常见的端口号。</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo netstat -aptn
sudo apt-get install ufw
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp

sudo ufw <span class="nb">enable</span>
sudo ufw status
</code></pre></td></tr></table>
</div>
</div><p>浏览器测试 <code>http://10.50.40.237</code>，返回预期的<code>Hello Asp.Net Core WebApi 3.1!</code>，完美😁。还有一个小坑就是 https 还没有配置。</p>
<h3 id="自动化脚本">自动化脚本</h3>
<p>在开发阶段，需要<strong>经常得编译，打包，上传</strong>。虽然 VS2019 具有直接发布到 FTP 的功能，不过我没有使用。一方面，该功能从来没用过，另一方面，还是想自己写个更加灵活的脚本。<br>
目前只实现了 编译，打包，上传的功能，后续再增加 ssh 登录，解压，重启 asp.net 。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bat" data-lang="bat"><span class="k">echo</span> only win10

<span class="k">cd</span> D:\Projects\lst\01-MyWebApi\MyWebApi
<span class="c1">rem 已注释：dotnet publish --output bin/publish/ --configuration Release --runtime linux-x64 --framework netcoreapp3.1 --self-contained false</span>
dotnet publish -p:PublishProfileFullPath=/Properties/PublishProfiles/FolderProfile.pubxml --output bin/publish/

<span class="k">cd</span> bin
tar.exe -a -c -f publish.zip publish

<span class="s2">&#34;C:\Program Files\PuTTY\psftp.exe&#34;</span>

open 10.50.40.237
Welcome123
put <span class="s2">&#34;D:\Projects\lst\01-LstWebApi\LenovoSmartToolWebApi\bin\publish.zip&#34;</span>
<span class="k">exit</span>

<span class="c1">rem 已注释：&#34;C:\Program Files\PuTTY\putty.exe&#34; user@10.40.50.237 22 -pw password</span>

<span class="k">pause</span>
</code></pre></td></tr></table>
</div>
</div><p>另外，用一个 WinForm 的测试小程序，尝试了 <code>self-contained = true</code> 这种发布方式，不需要客户端安装 net core 就能运行，发现编译后从 1M+ 大幅增加到 150M+ ，妥妥的吓坏了。即使使用了 <code>PublishTrimmed=true</code> <a href="https://docs.microsoft.com/zh-cn/dotnet/core/deploying/trim-self-contained">《剪裁独立部署和可执行文件》</a>，大小也有 100M+，果断放弃。</p>
<h2 id="其他的改动">其他的改动</h2>
<h3 id="log4net">log4net</h3>
<p>log4net 由 <code>1.2.13.0</code> 升级到 <code>2.0.8</code>后，初始化配置文件方法新增一个参数<code>ILoggerRepository</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">InitLog4NetConfig</span><span class="p">(</span><span class="kt">string</span> <span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">_rep</span> <span class="p">=</span> <span class="n">LogManager</span><span class="p">.</span><span class="n">GetRepository</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetCallingAssembly</span><span class="p">());</span>
    <span class="n">log4net</span><span class="p">.</span><span class="n">Config</span><span class="p">.</span><span class="n">XmlConfigurator</span><span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">_rep</span><span class="p">,</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">FileInfo</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>部署到 Ubuntu 后，发现 log4net 报错。需要把 <code>log4net.Appender.ColoredConsoleAppender</code> 替换为 <code>log4net.Appender.ManagedColoredConsoleAppender</code>。是由于<strong>不同的 Appender 支持的 Framework 不同</strong>， ColoredConsoleAppender 支持 NET Framework 1.0~4.0 ， ManagedColoredConsoleAppender 支持 NET Framework 2.0+ 。详见：<a href="https://logging.apache.org/log4net/release/framework-support.html">《Apache log4net™ Supported Frameworks》</a></p>
<h3 id="framework-40-的-md5-方法废弃">Framework 4.0 的 md5 方法废弃</h3>
<p>MD5 摘要也出现问题，需要更改。原因是 HashPasswordForStoringInConfigFile 在 net core 中已经不可用了，该方法在 framework 4.5 中也提示为废弃的方法。修改为下面新的 MD5 方法即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">GetOldMD5</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">FormsAuthentication</span><span class="p">.</span><span class="n">HashPasswordForStoringInConfigFile</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&#34;MD5&#34;</span><span class="p">).</span><span class="n">ToLower</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">GetNewMD5</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">MD5</span> <span class="n">md5</span> <span class="p">=</span> <span class="n">MD5</span><span class="p">.</span><span class="n">Create</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">retVal</span> <span class="p">=</span> <span class="n">md5</span><span class="p">.</span><span class="n">ComputeHash</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
        <span class="n">StringBuilder</span> <span class="n">_sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">retVal</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">_sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">retVal</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ToString</span><span class="p">(</span><span class="s">&#34;x2&#34;</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">_sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="datetimeoffset-和-datetime">DateTimeOffset 和 DateTime</h3>
<p>以前从来没有考虑过 UTC 时间，这次深深的上了一课， WebApi 中所有传递的时间全部是 UTC 时间。 <code>DateTime.MinValue</code> 转化为 UTC 时间后，可能会出现小于 <code>0001\01\01 00:00:00</code>的时间。需要额外处理一下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">RequestPartialContent</span><span class="p">(</span><span class="kt">long</span> <span class="n">_userId</span><span class="p">,</span> <span class="n">DateTime</span> <span class="n">_newDataTime</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Uid</span> <span class="p">=</span> <span class="n">_userId</span><span class="p">;</span>

    <span class="c1">// 转化为 utc 时间后，可能会小于 MinValue
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_newDataTime</span><span class="p">.</span><span class="n">ToUniversalTime</span><span class="p">()</span> <span class="p">&lt;=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">MinValue</span><span class="p">.</span><span class="n">UtcDateTime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">StartDateVersion</span> <span class="p">=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">MinValue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">StartDateVersion</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DateTimeOffset</span><span class="p">(</span><span class="n">_newDataTime</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="总结">总结</h2>
<p>目前，只迁移了一部分的 WCF 接口过来，等待部署到生产环境，可以稳定运行后，再将剩余部分全部迁移过来。这次的尝试比较成功：</p>
<ol>
<li>一是满足了基本需求，<strong>较少改动老旧代码</strong>；</li>
<li>二是大部分<strong>代码由工具生成</strong>，比如 API 文档，接口的实体类；</li>
<li>三是很多常用功能，都有<strong>现成的插件来</strong>完成。</li>
</ol>
<p>我只需要修改编辑器的 ERROR 的提示就可以了。<strong>感觉没有写什么代码</strong>🤣。。。顶多只写了几行<strong>粘合代码</strong>🤣，一种搭积木的感觉😝。其中 asp.net web api 还有很多的功能没有使用，还需要更加细化到项目中。路漫漫~~</p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Long</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2020-08-14 23:46
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">原创文章，如需转载请注明文章作者和出处。<br/><a rel="license noopener" href="https://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank">署名 4.0 国际 (CC BY 4.0)</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://mrbenwang.github.io/tags/net-core/">net core</a>
          <a href="https://mrbenwang.github.io/tags/web-api/">web api</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/2020/20200813-wcf-to-aspnetcore-grpc/">
            <span class="next-text nav-default">*旧 WCF 项目迁移到 asp.net core &#43; gRPC 的尝试</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "MrBenWang/comments-for-my-blog"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:wzlblair@foxmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://www.facebook.com/laowang.atlas/" rel="me noopener" class="iconfont"
      title="facebook"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M965.7344 2.7648c14.848 0 28.2624 5.5296 40.2432 16.6912C1017.9584 30.5152 1024 43.52 1024 58.2656l0 910.2336c0 14.848-6.0416 27.7504-18.0224 38.8096C993.8944 1018.4704 980.48 1024 965.7344 1024L704.9216 1024 704.9216 629.9648l133.2224 0 19.456-155.4432-152.576 0L705.024 373.0432c0-50.688 25.9072-76.0832 77.7216-76.0832l80.4864 0L863.232 163.5328c-27.7504-5.4272-67.4816-8.192-119.296-8.192-59.1872 0-106.8032 18.0224-142.9504 54.0672C564.736 245.5552 546.7136 296.0384 546.7136 360.7552l0 113.7664L413.4912 474.5216l0 155.4432 133.2224 0L546.7136 1024 55.5008 1024c-14.848 0-27.7504-5.5296-38.8096-16.6912C5.5296 996.2496 0 983.3472 0 968.4992L0 58.2656C0 43.52 5.5296 30.5152 16.6912 19.456c11.0592-11.0592 24.064-16.6912 38.8096-16.6912L965.7344 2.7648z"></path>
</svg>

    </a>
  
    <a href="https://github.com/MrBenWang" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/wzlblair" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>
  
    <a href="https://space.bilibili.com/344871908" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://mrbenwang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2007 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Long
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  











  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>




  <script src="/js/custom.js"></script>


</body>
</html>
